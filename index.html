<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Race Radar | Official Dark</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

    <style>
        @import url('https://fonts.googleapis.com/css2?family=Orbitron:wght@900&family=Inter:wght@400;700&display=swap');
        
        body { background-color: #0d0d0d; color: white; font-family: 'Inter', sans-serif; margin: 0; padding-bottom: 5rem; }
        .race-font { font-family: 'Orbitron', sans-serif; }
        .no-scrollbar::-webkit-scrollbar { display: none; }
        
        .logo-container {
            width: 90px; height: 90px; 
            background: #1a1a1a; 
            border-radius: 20px; display: flex; align-items: center; 
            justify-content: center; border: 2px solid #facc15;
            box-shadow: 0 0 20px rgba(250, 204, 21, 0.3);
        }

        .racing-card { 
            background: #1a1a1a; border-radius: 18px; padding: 1.25rem; 
            margin-bottom: 1rem; border: 1px solid #333;
        }

        /* Dark Map Fix */
        #map { height: 350px; width: 100%; z-index: 1; background: #0d0d0d; }

        .active-filter { background-color: #facc15 !important; color: #000 !important; font-weight: 900; }
        .nav-pill { background: #1a1a1a; border: 1px solid #333; color: white; transition: all 0.2s; }
    </style>
</head>
<body>

    <header class="p-6 flex flex-col items-center bg-[#0d0d0d]">
        <div class="logo-container mb-4">
            <svg viewBox="0 0 100 100" class="w-14 h-14">
                <ellipse cx="50" cy="80" rx="35" ry="12" stroke="#facc15" stroke-width="3" fill="none" opacity="0.6"/>
                <path d="M50 20 C 35 20 25 32 25 45 C 25 65 50 85 50 85 C 50 85 75 65 75 45 C 75 32 65 20 50 20Z" fill="#333" stroke="#facc15" stroke-width="2"/>
                <circle cx="50" cy="45" r="8" fill="#facc15"/>
                <g transform="translate(30,10) scale(0.3)">
                    <rect width="20" height="20" fill="white"/><rect x="20" width="20" height="20" fill="black"/>
                    <rect y="20" width="20" height="20" fill="black"/><rect x="20" y="20" width="20" height="20" fill="white"/>
                </g>
                <g transform="translate(55,10) scale(0.3)">
                    <rect width="20" height="20" fill="white"/><rect x="20" width="20" height="20" fill="black"/>
                    <rect y="20" width="20" height="20" fill="black"/><rect x="20" y="20" width="20" height="20" fill="white"/>
                </g>
                <path d="M25 55 H 75 L 68 50 M 75 55 L 68 60" stroke="#facc15" stroke-width="4" stroke-linecap="round"/>
            </svg>
        </div>
        <h1 class="race-font text-3xl italic text-white uppercase">RACE <span class="text-yellow-400">RADAR</span></h1>
    </header>

    <div id="map"></div>

    <nav class="sticky top-0 z-[1000] bg-[#0d0d0d]/90 backdrop-blur-md border-b border-white/10 py-4">
        <div class="flex overflow-x-auto px-4 space-x-3 no-scrollbar">
            <button onclick="filterBy('Alle')" class="filter-btn active-filter nav-pill px-6 py-2 rounded-xl text-[11px] uppercase font-black shrink-0">Alle</button>
            <button onclick="filterBy('Auto')" class="filter-btn nav-pill px-6 py-2 rounded-xl text-[11px] uppercase font-black shrink-0">Auto</button>
            <button onclick="filterBy('Motorrad')" class="filter-btn nav-pill px-6 py-2 rounded-xl text-[11px] uppercase font-black shrink-0">Motorrad</button>
            <button onclick="filterBy('Kart')" class="filter-btn nav-pill px-6 py-2 rounded-xl text-[11px] uppercase font-black shrink-0">Kart</button>
            <button onclick="filterBy('Sim')" class="filter-btn nav-pill px-6 py-2 rounded-xl text-[11px] uppercase font-black shrink-0">Sim</button>
        </div>
    </nav>

    <main id="event-list" class="p-4"></main>

    <script>
        const supabaseUrl = 'https://xrtozurcysifqapzcoeg.supabase.co
';
        const supabaseKey = 'sb_publishable_O_rt07lONV8ZeNF6KZuJ9g_1ls0zS2v';
        const _supabase = supabase.createClient(supabaseUrl, supabaseKey);

        let map, markers = [], allEvents = [];

        function initMap(lat, lon) {
            if (!map) {
                map = L.map('map', { zoomControl: false }).setView([lat, lon], 7);
                // CARTO DB DARK TILES - Stabilster Dark Mode
                L.tileLayer('https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png', {
                    attribution: '&copy; OpenStreetMap contributors &copy; CARTO'
                }).addTo(map);
            }
        }

        async function fetchEvents() {
            const list = document.getElementById('event-list');
            list.innerHTML = '<p class="text-center p-10 text-gray-500 animate-pulse">RADAR AKTIV...</p>';

            navigator.geolocation.getCurrentPosition(async (pos) => {
                initMap(pos.coords.latitude, pos.coords.longitude);
                try {
                    const { data, error } = await _supabase.from('events').select('*');
                    if (error) throw error;
                    allEvents = data || [];
                    renderEvents(allEvents);
                } catch (e) {
                    list.innerHTML = `<p class="text-red-500 p-10">Datenbank-Fehler: ${e.message}</p>`;
                }
            }, () => {
                // Fallback: Mitte Deutschland
                initMap(51.1657, 10.4515);
                fetchEventsNoGPS();
            });
        }

        async function fetchEventsNoGPS() {
            const { data } = await _supabase.from('events').select('*');
            allEvents = data || [];
            renderEvents(allEvents);
        }

        function renderEvents(events) {
            const list = document.getElementById('event-list');
            list.innerHTML = '';
            markers.forEach(m => map.removeLayer(m));
            markers = [];

            if (events.length === 0) {
                list.innerHTML = '<p class="text-center p-20 text-gray-700 font-bold uppercase tracking-widest">Keine Events</p>';
                return;
            }

            events.forEach(e => {
                if(e.latitude && e.longitude) {
                    // Marker in Gelb passend zum Design
                    const m = L.circleMarker([e.latitude, e.longitude], {
                        color: '#facc15',
                        fillColor: '#facc15',
                        fillOpacity: 0.8,
                        radius: 8
                    }).addTo(map).bindPopup(`<span style="color:black; font-weight:bold;">${e.name}</span>`);
                    markers.push(m);
                }
                list.innerHTML += `
                    <div class="racing-card shadow-lg shadow-black/50">
                        <div class="flex justify-between mb-2">
                            <span class="text-[10px] font-black uppercase text-yellow-400 tracking-wider">${e.category}</span>
                            <span class="text-[10px] text-gray-500 uppercase font-bold">${e.description || ''}</span>
                        </div>
                        <h3 class="race-font text-xl text-white uppercase italic mb-5 leading-tight">${e.name}</h3>
                        <button onclick="window.open('https://www.google.com/maps/dir/?api=1&destination=${e.latitude},${e.longitude}')" 
                                class="w-full bg-white text-black py-4 rounded-2xl font-black uppercase text-[12px] hover:bg-yellow-400 transition-colors">
                            RENNSTRECKE ANSTEUERN
                        </button>
                    </div>`;
            });
        }

        function filterBy(cat) {
            document.querySelectorAll('.filter-btn').forEach(b => b.classList.toggle('active-filter', b.innerText.includes(cat)));
            if (cat === 'Alle') renderEvents(allEvents);
            else renderEvents(allEvents.filter(e => 
                e.category.toLowerCase() === cat.toLowerCase() || 
                (e.description && e.description.toLowerCase().includes(cat.toLowerCase()))
            ));
        }

        fetchEvents();
    </script>
</body>
</html>
